---
title: "Home based anxiety interventions meta-analysis"
author: "Tamas Nagy"
date: "6/29/2020"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
csl: apa.csl
bibliography: [references.bib]
---

CHANGES:  

- redo all analyses and viz without the outlier study, using REML estimation
- keep only one forest and funnel plot for both MAs
- do the meta regressions
- all previous scripts can be found through git, so older script parts are removed

# Prepare environment and data

```{r Packages & settings, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(encoding = 'UTF-8')

library(tidyverse)
library(readxl)
library(metafor)
library(metaviz)
library(dmetar)
library(janitor)
library(citr)
library(osfr)
library(DiagrammeR)

```

```{r Prep bibliography, eval=FALSE, include=FALSE}
# This does not have to be run
# Creates a tidy bibliography from the local bib file
citr::tidy_bib_file(messy_bibliography = "d:/Documents/Mendeley references/library.bib",
                    file = "references.bib", 
                    rmd_file = "index.Rmd",
                    encoding = "UTF-8")

```

```{r Download data from osf}
# Authenticate using a PAT
osf_pat <- read_lines("osf_pat.txt")
osf_auth(token = osf_pat)

# Retrieve data to data folder
osf_file <- 
  osf_retrieve_file("bqy2p") %>%
  osf_download(path = "data/",
               conflicts = "overwrite",
               progress = TRUE)


```

# Analysis


```{r Load data}
cbt <-
  read_excel(osf_file$local_path, na = c("", "N/A")) %>% 
  clean_names() %>% 
  # Get the female ratio
  mutate(female = map_dbl(female_n_total_n, ~eval(parse(text = .x))),
         sessions_completed_totalsessions = str_replace_all(sessions_completed_totalsessions, ",", "."),
         completed_sessions = map_dbl(sessions_completed_totalsessions, 
                                      ~eval(parse(text = .x))))

```

The meta-analyses models were recaucluated using REML estimation. Using this only slightly changes the results, but IMO it is a more appropriate and defensible choice  @Viechtbauer2005.

```{r Build meta models}
# Model for the children self-report MA
selfrep_df <- 
  cbt %>% 
  filter(outcome == "children") 

mod_selfrep <-  
  rma(yi = hedges_g, 
      sei = hedges_se, 
      data = selfrep_df, 
      method = "REML")

mod_selfrep


# Model for the clinician rating MA
rate_df <- 
  cbt %>%
  filter(outcome == "clinician")

mod_rate <-
  rma(yi = hedges_g,
      sei = hedges_se, 
      data = rate_df,
      method = "REML")

mod_rate

```

## Outlier detection

Studies that has a confidence interval completely outside of the aggregated effect's CI should be considered outliers. We identified the 2nd study and the 1st study from the self-report and clinician rated studies as outliers (these effect sizes came from the same study), so we removed this study, and recalculated the meta-analyses.

```{r outlier detection}
# Self-report
find.outliers(mod_selfrep)
# Clinician rating
find.outliers(mod_rate)
```


```{r recalculate MA without outliers}
# Remove outliers from self-report data
selfrep_df <- 
  cbt %>% 
  filter(outcome == "children") %>% 
  slice(-2)

# Corrected model for self-report data
mod_selfrep <-  
  rma(yi = hedges_g, 
           sei = hedges_se, 
           data = selfrep_df, 
           method = "REML")

find.outliers(mod_selfrep)

# There is still one outlier, number 5 in the original dataset.
# Let's remove it as well.
selfrep_df <- 
  cbt %>% 
  filter(outcome == "children") %>% 
  slice(-2, -5)

mod_selfrep <-  
  rma(yi = hedges_g, 
           sei = hedges_se, 
           data = selfrep_df, 
           method = "REML")

# No more outliers!
find.outliers(mod_selfrep)
# This is the final model
mod_selfrep

# Remove outliers from clinician-rating data


rate_df <-   
  cbt %>% 
  filter(outcome == "clinician") %>% 
  slice(-1)

# Model for the clinician rating MA

mod_rate <-
  rma(yi = hedges_g,
      sei = hedges_se, 
      data = rate_df,
      method = "REML")

# No further outliers
find.outliers(mod_rate)
# Final model
mod_rate

```



# Forest plots
## Self-report

```{r tables will be added}
# Create tables that will be added to the forest plots
selfrep_table <-
  selfrep_df %>% 
  select(Study = study_name, N = sample_size_total)

selfrep_summary <- 
  selfrep_table %>% 
  group_by(name = "Aggregated effect") %>% 
  summarise(N = sum(N))

rate_table <-
  rate_df %>% 
  select(Study = study_name, N = sample_size_total)

rate_summary <- 
  rate_table %>% 
  group_by(name = "Aggregated effect") %>% 
  summarise(N = sum(N))
```

## Self-report
```{r fig.width = 9}
viz_forest(mod_selfrep, 
           study_table = selfrep_table,
           text_size = 4, 
           annotate_CI = TRUE, 
           xlab = "Hedges's g", 
           summary_table = selfrep_summary)
```

## Clinician rating
```{r fig.width = 9, warning = FALSE}
viz_forest(mod_rate, 
           study_table = rate_table,
           text_size = 3.5, 
           xlab = "Hedges'g", 
           summary_table = rate_summary,
           annotate_CI = TRUE)
```

# Funnel plots
## Self-report

As there seems to be some publication or small study bias, we can try to correct for that. Both models remain significant after trim-and-fill imputed studies. Also, the if we compare the overall effect size with TAF studies included, the effects remain similar.


```{r}
# trimandfill tails for the first model, while it work in  the funnel plot 
trimfill(selfrep_df$hedges_g,
         selfrep_df$hedges_se,
         ma.fixed = FALSE,
         method.tau = "REML")

# Egger's test
regtest(mod_selfrep, model = "lm")

viz_funnel(mod_selfrep, 
           method = "RE",
           sig_contours = FALSE,
           contours = TRUE,
           trim_and_fill = TRUE,
           text_size = 4)


```

## Clinician rating

```{r}
trimfill(rate_df$hedges_g,
         rate_df$hedges_se,
         ma.fixed = FALSE,
         method.tau = "REML")
# Egger's test
regtest(mod_rate, model = "lm")

viz_funnel(mod_rate, 
           method = "RE",
           sig_contours = FALSE, 
           trim_and_fill = TRUE,
           contours = TRUE,
           text_size = 4)

```

# Moderation analyses

## Self-rep

```{r}
# Intervention characteristics
## Family or youth focus (focus)
rma.uni(hedges_g, sei = hedges_se, data = selfrep_df, mods = ~focus) %>% 
  anova()
## Therapist involvement (therapist_involvement)
rma.uni(hedges_g, sei = hedges_se, data = selfrep_df, mods = ~therapist_involvement) %>% 
  anova()

## Place of delivery
rma.uni(hedges_g, sei = hedges_se, data = selfrep_df, mods = ~placeof_delivery) %>% anova()
## Average length
rma.uni(hedges_g, sei = hedges_se, data = selfrep_df, mods = ~completed_sessions)  %>% anova()

# Study characteristics
## Study quality
rma.uni(hedges_g, sei = hedges_se, data = selfrep_df, mods = ~study_quality) %>% anova()
## Anxiety measure
rma.uni(hedges_g, sei = hedges_se, data = selfrep_df, mods = ~anxiety_measure) %>%  anova()
## Intended length
rma.uni(hedges_g, sei = hedges_se, data = selfrep_df, mods = ~intervention_length_n_of_modules) %>% anova()

# Participant characteristics
## Age
rma.uni(hedges_g, sei = hedges_se, data = selfrep_df, mods = ~avg_age_pop) %>% anova()
## Female ratio
rma.uni(hedges_g, sei = hedges_se, data = selfrep_df, mods = ~female) %>% anova()
## Clinical status
rma.uni(hedges_g, sei = hedges_se, data = selfrep_df, mods = ~clinical_status) %>% anova()

```

## Clinician rating
```{r}
## Method
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~method) %>% anova()
## Family or youth focus (focus)
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~focus) %>% anova()
## Therapist involvement (therapist_involvement)
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~therapist_involvement) %>% anova()
## Clinical status
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~clinical_status) %>% anova()
## Place of delivery
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~placeof_delivery) %>% anova()
## Intended length
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~intervention_length_n_of_modules) %>% anova()
## Study quality
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~study_quality) %>% anova()
## Clinician blinding
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~clinician_blinding) %>% anova()

rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~intervention_length_n_of_modules) %>% anova()
## Average length
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~completed_sessions) %>% anova()
## Age
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~avg_age_pop) %>% anova()
## Female ratio
rma.uni(hedges_g, sei = hedges_se, data = rate_df, mods = ~female) %>% anova()



```

## Dropout analysis
```{r}
selfrep_df %>% 
  select(study_name, drop_out_int, drop_out_cont) %>% 
  pivot_longer(-study_name,
               names_to = "outcome",
               values_to = "group") %>% 
  group_by(outcome) %>% 
  summarise(avg_dropout = mean(group, na.rm = TRUE),
            med_dropout = median(group, na.rm = TRUE))

  
rate_df %>% 
  select(study_name, drop_out_int, drop_out_cont) %>% 
  pivot_longer(-study_name,
               names_to = "outcome",
               values_to = "group") %>% 
  group_by(outcome) %>% 
  summarise(avg_dropout = mean(group),
            med_dropout = median(group))

```

## Dropouts and intervention length association
## All dropouts as moderator


# Blinding?

# Flowcart
WIP
```{r}


grViz("digraph flowchart {
      # node definitions with substituted label text
      node [fontname = Helvetica, shape = rectangle]  
      cat1 [label = 'Screening']
      
      node [fontname = Helvetica, shape = rectangle]        
      tab1 [label = 'Papers identified by database searches \\n k = 3113']
      tab2 [label = 'Papers screened based on title and abstract \\n k = 431']
      tab3 [label = 'Full text assessed for eligibility\\n k = 128']
      tab4 [label = 'Papers included for meta-analysis\\n k = 18']
      tab5 [label = 'Papers excluded based on title\\n k = 2682']
      tab6 [label = 'Papers excluded based on abstract\\n k = 303']
      tab7 [label = 'Papers excluded after full text assessed\\n k = 110']

      # edge definitions with the node IDs
      cat1
      tab1 -> tab2 -> tab3 -> tab4
      tab1 -> tab5
      tab2 -> tab6
      tab3 -> tab7
      }


      ")
```


# References  
